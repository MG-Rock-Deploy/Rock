// Fluidbox
// Description: Replicating the seamless lightbox transition effect seen on Medium.com, with some improvements
// Version: 1.3.1 + Rock Rescale Fix
// Author: Terry Mun
// Author URI: http://terrymun.com

!function(e,t){jQuery.fn[t]=function(e){return e?this.bind("resize",(i=e,function(){var e=this,t=arguments;s?clearTimeout(s):o&&i.apply(e,t),s=setTimeout(function(){o||i.apply(e,t),s=null},a||100)})):this.trigger(t);var i,a,o,s}}(jQuery,"smartresize"),function(e){e.fn.fluidbox=function(t){var i=e.extend(!0,{viewportFill:.95,overlayColor:"rgba(255,255,255,.85)",debounceResize:!0,rescale:!1,stackIndex:1040,stackIndexDelta:10,closeTrigger:[{selector:".fluidbox-overlay",event:"click"},{selector:"document",event:"keyup",keyCode:27}]},t);i.stackIndex<i.stackIndexDelta&&(i.stackIndexDelta=i.stackIndex),$fbOverlay=e("<div />",{id:"fluidbox-overlay",class:"fluidbox-overlay",css:{"z-index":i.stackIndex}});var a,o=this,s=e(window),n=function(){e(".fluidbox-opened").trigger("click")},d=function(e){var t=e.find("img"),i=e.find(".fluidbox-ghost"),a=s.scrollTop()-t.offset().top+t.data("imgHeight")*(t.data("imgScale")-1)*.5+.5*(s.height()-t.data("imgHeight")*t.data("imgScale")),o=t.data("imgWidth")*(t.data("imgScale")-1)*.5+.5*(s.width()-t.data("imgWidth")*t.data("imgScale"))-t.offset().left,n=t.data("imgScale");i.css({transform:"translate("+parseInt(10*o)/10+"px,"+parseInt(10*a)/10+"px) scale("+parseInt(1e3*n)/1e3+")"})},l=function(e){if(a=s.width()/s.height(),e.hasClass("fluidbox")){var t=e.find("img"),o=e.find(".fluidbox-ghost"),n=e.find(".fluidbox-wrap"),d=t.data();function l(){d.imgWidth=t.width(),d.imgHeight=t.height(),d.imgRatio=d.imgWidth/d.imgHeight,i.rescale&&(d.natW=t[0].naturalWidth,d.natH=t[0].naturalHeight,d.thumbRatio=d.natW/d.natH,d.imgRatio>d.thumbRatio?d.imgHeight=d.imgWidth*d.thumbRatio):(d.imgWidth=d.imgHeight*d.thumbRatio)),o.css({width:d.imgWidth,height:d.imgHeight,top:t.offset().top-n.offset().top,left:t.offset().left-n.offset().left}),a>d.thumbRatio?d.imgScale=s.height()*i.viewportFill/d.imgHeight:d.imgScale=s.width()*i.viewportFill/d.imgWidth}l(),t.load(l)}},c=function(t){if(e(this).hasClass("fluidbox")){var a=e(this),o=e(this).find("img"),s=e(this).find(".fluidbox-ghost"),n=e(this).find(".fluidbox-wrap"),l={};0!==e(this).data("fluidbox-state")&&e(this).data("fluidbox-state")?(a.data("fluidbox-state",0).removeClass("fluidbox-opened").addClass("fluidbox-closed"),l.open&&window.clearTimeout(l.open),l.close=window.setTimeout(function(){e(".fluidbox-overlay").remove(),n.css({"z-index":i.stackIndex-i.stackIndexDelta})},10),e(".fluidbox-overlay").css({opacity:0}),s.css({transform:"translate(0,0) scale(1)",opacity:0}),o.css({opacity:1})):e("<img />",{src:o.attr("src")}).load(function(){a.append($fbOverlay).data("fluidbox-state",1).removeClass("fluidbox-closed").addClass("fluidbox-opened"),l.close&&window.clearTimeout(l.close),l.hideGhost&&window.clearTimeout(l.hideGhost),l.open=window.setTimeout(function(){e(".fluidbox-overlay").css({opacity:1})},10),n.css({"z-index":i.stackIndex+i.stackIndexDelta}),s.css({"background-image":"url("+o.attr("src")+")",opacity:1}),o.css({opacity:0}),e("<img />",{src:a.attr("href")}).load(function(){s.css({"background-image":"url("+a.attr("href")+")"})}),d(a)}),t.preventDefault()}};i.closeTrigger&&e.each(i.closeTrigger,function(t){var a=i.closeTrigger[t];"window"!=a.selector?"document"==a.selector?a.keyCode?e(document).on(a.event,function(e){e.keyCode==a.keyCode&&n()}):e(document).on(a.event,n):e(document).on(a.event,i.closeTrigger[t].selector,n):s.on(a.event,n)}),o.each(function(t){if(e(this).is("a")&&1===e(this).children().length&&e(this).children().is("img")){var a=e("<div />",{class:"fluidbox-wrap",css:{"z-index":i.stackIndex-i.stackIndexDelta}}),o=e(this);o.addClass("fluidbox").wrapInner(a).find("img").css({opacity:1}).after('<div class="fluidbox-ghost" />').each(function(){var t=e(this);t.width()>0&&t.height()>0?(l(o),o.click(c)):t.load(function(){l(o),o.click(c)})})}});var r=function(){o.each(function(){l(e(this))});var t=e("a.fluidbox.fluidbox-opened");t.length>0&&d(t)};return i.debounceResize?e(window).smartresize(r):e(window).resize(r),o}}(jQuery);
